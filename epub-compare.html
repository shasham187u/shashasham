<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB ë¹„êµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg: #fafaff;
            --surface: #ffffff;
            --border: #e9ecf5;
            --text: #3d4451;
            --text-soft: #8890a0;
            --pink: #ffb3d1;
            --blue: #a8d5ff;
            --purple: #d4c5f9;
            --add-bg: #f0f9ff;
            --add-text: #5b9fd1;
            --remove-bg: #fff5f8;
            --remove-text: #d18ba0;
            --hover: #f5f7fb;
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .top-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1.2rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .upload-btn {
            padding: 0.6rem 1.2rem;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        
        .upload-btn:hover {
            background: var(--hover);
            border-color: var(--purple);
        }
        
        .upload-btn.active {
            background: linear-gradient(135deg, var(--pink), var(--purple));
            color: white;
            border-color: transparent;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 340px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar.show {
            display: flex;
        }
        
        .sidebar-header {
            padding: 1rem 1.2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sidebar-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-soft);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .file-count {
            font-size: 0.8rem;
            color: var(--text-soft);
            background: var(--hover);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
        }
        
        .tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .tree-item {
            padding: 0.6rem 0.8rem;
            margin: 0.2rem 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.9rem;
        }
        
        .tree-item:hover {
            background: var(--hover);
        }
        
        .tree-item.selected {
            background: linear-gradient(135deg, rgba(255, 179, 209, 0.15), rgba(212, 197, 249, 0.15));
            border-left: 3px solid var(--purple);
            padding-left: calc(0.8rem - 3px);
        }
        
        .tree-item.modified {
            border-left: 3px solid var(--pink);
            padding-left: calc(0.8rem - 3px);
        }
        
        .tree-item.selected.modified {
            background: linear-gradient(135deg, rgba(255, 179, 209, 0.2), rgba(212, 197, 249, 0.2));
        }
        
        .file-icon {
            font-size: 1rem;
        }
        
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .file-badge {
            font-size: 0.7rem;
            background: var(--remove-bg);
            color: var(--remove-text);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .folder-item {
            padding: 0.5rem 0.8rem;
            font-size: 0.85rem;
            color: var(--text-soft);
            font-weight: 600;
            margin-top: 0.8rem;
        }
        
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: none;
            align-items: center;
            justify-content: space-between;
        }
        
        .content-header.show {
            display: flex;
        }
        
        .file-info-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .current-file {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .file-meta {
            font-size: 0.8rem;
            color: var(--text-soft);
            display: flex;
            gap: 1.5rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .diff-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-btn {
            padding: 0.5rem 0.9rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: var(--hover);
        }
        
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .diff-count {
            font-size: 0.85rem;
            color: var(--text-soft);
            padding: 0.5rem 0.8rem;
        }
        
        .view-area {
            flex: 1;
            overflow-y: auto;
            background: var(--bg);
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border);
            min-height: 100%;
        }
        
        .pane {
            background: var(--surface);
            padding: 2rem;
        }
        
        .pane-header {
            position: sticky;
            top: 0;
            background: var(--surface);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid;
            z-index: 5;
        }
        
        .pane:first-child .pane-header {
            border-bottom-color: var(--remove-text);
        }
        
        .pane:last-child .pane-header {
            border-bottom-color: var(--add-text);
        }
        
        .pane-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-soft);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .diff-text {
            font-size: 0.95rem;
            line-height: 2;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .ws {
            position: relative;
            font-weight: 500;
            padding: 0 0.2rem;
            border-radius: 3px;
            font-size: 0.85em;
            display: inline-block;
            text-align: center;
        }
        
        /* ì¼ë°˜ ê³µë°± - ë§¤ìš° ì—°í•˜ê²Œ */
        .ws-normal {
            color: var(--text-soft);
            background: transparent;
            opacity: 0.3;
        }
        
        /* íŠ¹ìˆ˜ ë³´ì´ì§€ ì•ŠëŠ” ë¬¸ì - ì€ì€í•˜ê²Œ */
        .ws-special {
            color: var(--text);
            font-weight: 600;
            padding: 0.1rem 0.3rem;
            border: 1px solid;
            min-width: 1em;
            opacity: 0.7;
        }
        
        body.hide-whitespace .ws-normal {
            display: none;
        }
        
        body.hide-all-whitespace .ws {
            display: none;
        }
        
        .ws:hover {
            opacity: 1;
        }
        
        .ws:hover::after {
            content: attr(data-code);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3748;
            color: white;
            padding: 0.4rem 0.7rem;
            border-radius: 5px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            margin-bottom: 0.3rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .ws-space { background: transparent; }
        .ws-nbsp { background: transparent; }
        .ws-tab { background: transparent; }
        .ws-newline { background: transparent; }
        .ws-cr { background: transparent; }
        .ws-crlf { background: transparent; }
        
        /* íŠ¹ìˆ˜ ë¬¸ì - ì—°í•œ íŒŒìŠ¤í…” ë°°ê²½ + ìƒ‰ìƒ í…Œë‘ë¦¬ */
        .ws-zwsp { background: #fff9e6; border-color: #ffd966; color: #b8860b; }
        .ws-zwj { background: #ffe8dd; border-color: #ff9f66; color: #cc5500; }
        .ws-zwnj { background: #ffe6f0; border-color: #ffa8c5; color: #cc0066; }
        .ws-wj { background: #f5e6ff; border-color: #d966ff; color: #8800cc; }
        .ws-shy { background: #e6f7ff; border-color: #66d9ff; color: #0088cc; }
        .ws-cgj { background: #e6ffef; border-color: #66ffb3; color: #00aa55; }
        .ws-em { background: #e6f2ff; border-color: #6bc5ff; color: #0077cc; }
        
        .ws-legend {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.8rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 50;
            max-width: 350px;
            max-height: 600px;
        }
        
        .ws-legend.show {
            display: block;
        }
        
        .ws-legend-title {
            font-weight: 700;
            margin-bottom: 0.8rem;
            color: var(--text);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .legend-close {
            cursor: pointer;
            color: var(--text-soft);
            font-size: 1.2rem;
            line-height: 1;
            padding: 0.2rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .legend-close:hover {
            background: var(--hover);
            color: var(--text);
        }
        
        .ws-legend-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin: 0.5rem 0;
            color: var(--text);
        }
        
        .removed {
            background: var(--remove-bg);
            color: var(--text);
            padding: 1px 3px;
            border-radius: 3px;
            text-decoration: line-through;
            border-left: 2px solid var(--remove-text);
            opacity: 0.85;
        }
        
        .added {
            background: var(--add-bg);
            color: var(--text);
            padding: 1px 3px;
            border-radius: 3px;
            border-left: 2px solid var(--add-text);
            opacity: 0.85;
        }
        
        .diff-marker {
            scroll-margin-top: 100px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 3rem;
            text-align: center;
            color: var(--text-soft);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.4;
        }
        
        .empty-text {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .loading {
            position: fixed;
            inset: 0;
            background: rgba(250, 250, 255, 0.95);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-box {
            background: var(--surface);
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--purple);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-text {
            font-size: 1rem;
            color: var(--text);
            font-weight: 500;
        }
        
        .stats-bar {
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: none;
            gap: 2rem;
            font-size: 0.85rem;
        }
        
        .stats-bar.show {
            display: flex;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .stat-label {
            color: var(--text-soft);
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--text);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--purple);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="top-bar">
            <div class="title">ğŸ“š EPUB ë¹„êµ</div>
            <button class="upload-btn" id="uploadBtn1" onclick="document.getElementById('file1').click()">
                <span id="fileName1">íŒŒì¼ 1 ì„ íƒ</span>
            </button>
            <button class="upload-btn" id="uploadBtn2" onclick="document.getElementById('file2').click()">
                <span id="fileName2">íŒŒì¼ 2 ì„ íƒ</span>
            </button>
            <input type="file" id="file1" accept=".epub" onchange="handleFile(1, this)">
            <input type="file" id="file2" accept=".epub" onchange="handleFile(2, this)">
        </div>
        
        <div class="main">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">íŒŒì¼ êµ¬ì¡°</div>
                    <div class="file-count" id="fileCount">0ê°œ íŒŒì¼</div>
                </div>
                <div class="tree-container" id="treeContainer"></div>
            </div>
            
            <div class="content">
                <div class="content-header" id="contentHeader">
                    <div class="file-info-bar">
                        <div class="current-file" id="currentFileName">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
                        <div class="file-meta" id="fileMeta"></div>
                    </div>
                    <div class="diff-nav" id="diffNav">
                        <button class="nav-btn" onclick="prevDiff()">â† ì´ì „</button>
                        <div class="diff-count" id="diffCount">0/0</div>
                        <button class="nav-btn" onclick="nextDiff()">ë‹¤ìŒ â†’</button>
                    </div>
                </div>
                
                <div class="view-area" id="viewArea">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“„</div>
                        <div class="empty-text">ë‘ ê°œì˜ EPUB íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                    </div>
                </div>
                
                <div class="stats-bar" id="statsBar">
                    <div class="stat">
                        <span class="stat-label">ì „ì²´ íŒŒì¼:</span>
                        <span class="stat-value" id="totalFiles">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">ìˆ˜ì •ë¨:</span>
                        <span class="stat-value" id="modifiedFiles">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">ì¶”ê°€:</span>
                        <span class="stat-value" id="totalAdded">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">ì‚­ì œ:</span>
                        <span class="stat-value" id="totalDeleted">0</span>
                    </div>
                    <button class="nav-btn" onclick="toggleWhitespaceMode()" id="wsToggleBtn" style="margin-left: auto;">íŠ¹ìˆ˜ë¬¸ìë§Œ í‘œì‹œ</button>
                    <button class="nav-btn" onclick="toggleLegend()">ë²”ë¡€</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="ws-legend" id="wsLegend">
        <div class="ws-legend-title">
            <span>ê³µë°± ë¬¸ì ë²”ë¡€</span>
            <span class="legend-close" onclick="toggleLegend()">âœ•</span>
        </div>
        
        <div style="background: var(--hover); padding: 0.6rem; border-radius: 6px; margin-bottom: 0.8rem; font-size: 0.75rem;">
            <strong>í˜„ì¬ ëª¨ë“œ:</strong> íŠ¹ìˆ˜ë¬¸ìë§Œ í‘œì‹œ<br>
            <span style="color: var(--text-soft);">ì¼ë°˜ ìŠ¤í˜ì´ìŠ¤/íƒ­/ê°œí–‰ì€ ìˆ¨ê¹€<br>ë²„íŠ¼ì„ ëˆŒëŸ¬ ì „í™˜í•˜ì„¸ìš”</span>
        </div>
        
        <div style="max-height: 350px; overflow-y: auto;">
            <div style="font-weight: 600; margin-top: 0.3rem; margin-bottom: 0.4rem; color: var(--text);">ì¼ë°˜ ê³µë°± (ê¸°ë³¸ ìˆ¨ê¹€)</div>
            <div class="ws-legend-item" style="opacity: 0.5;">
                <span class="ws ws-normal">Â·</span>
                <span>U+0020 ìŠ¤í˜ì´ìŠ¤</span>
            </div>
            <div class="ws-legend-item" style="opacity: 0.5;">
                <span class="ws ws-normal">â£</span>
                <span>U+00A0 NBSP</span>
            </div>
            <div class="ws-legend-item" style="opacity: 0.5;">
                <span class="ws ws-normal">â†’</span>
                <span>U+0009 íƒ­</span>
            </div>
            <div class="ws-legend-item" style="opacity: 0.5;">
                <span class="ws ws-normal">â†µ</span>
                <span>U+000A ê°œí–‰</span>
            </div>
            
            <div style="font-weight: 600; margin-top: 0.8rem; margin-bottom: 0.4rem; color: var(--text);">âš ï¸ ë³´ì´ì§€ ì•ŠëŠ” íŠ¹ìˆ˜ ë¬¸ì</div>
            <div class="ws-legend-item">
                <span class="ws ws-special ws-zwsp">âˆ…</span>
                <span>U+200B Zero-width space</span>
            </div>
            <div class="ws-legend-item">
                <span class="ws ws-special ws-wj">âŠ™</span>
                <span>U+2060 Word joiner</span>
            </div>
            <div class="ws-legend-item">
                <span class="ws ws-special ws-zwnj">âŠ˜</span>
                <span>U+200C Zero-width non-joiner</span>
            </div>
            <div class="ws-legend-item">
                <span class="ws ws-special ws-zwj">âŠ—</span>
                <span>U+200D Zero-width joiner</span>
            </div>
            <div class="ws-legend-item">
                <span class="ws ws-special ws-shy">Â¬</span>
                <span>U+00AD Soft hyphen</span>
            </div>
            <div class="ws-legend-item">
                <span class="ws ws-special ws-em">â–¡</span>
                <span>U+3000 ì „ê° ìŠ¤í˜ì´ìŠ¤</span>
            </div>
        </div>
        
        <div style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-soft);">
            ğŸ’¡ ê° ë¬¸ìì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ìœ ë‹ˆì½”ë“œ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="loading-box">
            <div class="spinner"></div>
            <div class="loading-text">ë¶„ì„ ì¤‘...</div>
        </div>
    </div>
    
    <script>
        let file1 = null, file2 = null;
        let name1 = '', name2 = '';
        let files1 = {}, files2 = {};
        let allFiles = [];
        let currentFile = null;
        let diffMarkers = [];
        let currentDiffIndex = 0;
        
        async function handleFile(num, input) {
            const file = input.files[0];
            if (!file) return;
            
            const btn = document.getElementById(`uploadBtn${num}`);
            const nameEl = document.getElementById(`fileName${num}`);
            
            btn.classList.add('active');
            nameEl.textContent = file.name;
            
            if (num === 1) {
                file1 = file;
                name1 = file.name;
            } else {
                file2 = file;
                name2 = file.name;
            }
            
            if (file1 && file2) {
                await compareFiles();
            }
        }
        
        async function compareFiles() {
            document.getElementById('loading').style.display = 'flex';
            
            try {
                files1 = await extractFiles(file1);
                files2 = await extractFiles(file2);
                
                const allPaths = new Set([...Object.keys(files1), ...Object.keys(files2)]);
                allFiles = [];
                
                let totalMod = 0, totalAdd = 0, totalDel = 0;
                
                for (const path of allPaths) {
                    const f1 = files1[path];
                    const f2 = files2[path];
                    
                    if (!f1 || !f2) {
                        allFiles.push({
                            path,
                            name: getFileName(path),
                            folder: getFolder(path),
                            modified: true,
                            added: !f1 ? (f2.text?.length || 0) : 0,
                            deleted: !f2 ? (f1.text?.length || 0) : 0,
                            date1: f1?.date,
                            date2: f2?.date,
                            isImage: f1?.isImage || f2?.isImage,
                            onlyInFile: !f1 ? 2 : 1
                        });
                        if (!f1) totalAdd += (f2.text?.length || 0);
                        if (!f2) totalDel += (f1.text?.length || 0);
                        totalMod++;
                        continue;
                    }
                    
                    if (f1.isImage && f2.isImage) {
                        const modified = f1.text !== f2.text;
                        if (modified) totalMod++;
                        
                        allFiles.push({
                            path,
                            name: getFileName(path),
                            folder: getFolder(path),
                            modified,
                            isImage: true,
                            added: 0,
                            deleted: 0,
                            date1: f1.date,
                            date2: f2.date,
                            size1: f1.size,
                            size2: f2.size
                        });
                        continue;
                    }
                    
                    const dmp = new diff_match_patch();
                    const diffs = dmp.diff_main(f1.text, f2.text);
                    dmp.diff_cleanupSemantic(diffs);
                    
                    let add = 0, del = 0;
                    diffs.forEach(([op, text]) => {
                        if (op === 1) add += text.length;
                        else if (op === -1) del += text.length;
                    });
                    
                    const modified = add > 0 || del > 0;
                    if (modified) totalMod++;
                    totalAdd += add;
                    totalDel += del;
                    
                    allFiles.push({
                        path,
                        name: getFileName(path),
                        folder: getFolder(path),
                        modified,
                        diffs,
                        added: add,
                        deleted: del,
                        date1: f1.date,
                        date2: f2.date,
                        isImage: false
                    });
                }
                
                allFiles.sort((a, b) => a.path.localeCompare(b.path));
                
                displayTree();
                updateStats(allFiles.length, totalMod, totalAdd, totalDel);
                
                document.getElementById('sidebar').classList.add('show');
                document.getElementById('statsBar').classList.add('show');
                document.getElementById('loading').style.display = 'none';
                
                // ì²« ë²ˆì§¸ íŒŒì¼ ìë™ ì„ íƒ
                if (allFiles.length > 0) {
                    setTimeout(() => {
                        const firstItem = document.querySelector('.tree-item');
                        if (firstItem) firstItem.click();
                    }, 100);
                }
                
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        async function extractFiles(file) {
            const zip = new JSZip();
            const contents = await zip.loadAsync(file);
            const result = {};
            
            const imageExts = /\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i;
            const textExts = /\.(html|xhtml|htm|css|xml|opf|ncx|txt|js)$/i;
            
            for (const [path, zipFile] of Object.entries(contents.files)) {
                if (zipFile.dir) continue;
                
                if (imageExts.test(path)) {
                    const base64 = await zipFile.async('base64');
                    result[path] = {
                        text: base64,
                        date: zipFile.date,
                        isImage: true,
                        size: base64.length
                    };
                } else if (textExts.test(path)) {
                    const content = await zipFile.async('text');
                    const text = path.match(/\.(html|xhtml|htm)$/i) ? stripHtml(content) : content;
                    result[path] = {
                        text,
                        date: zipFile.date,
                        isImage: false,
                        size: content.length
                    };
                } else {
                    const content = await zipFile.async('text');
                    result[path] = {
                        text: content,
                        date: zipFile.date,
                        isImage: false,
                        size: content.length
                    };
                }
            }
            
            return result;
        }
        
        function stripHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }
        
        function getFileName(path) {
            return path.split('/').pop();
        }
        
        function getFolder(path) {
            const parts = path.split('/');
            return parts.length > 1 ? parts.slice(0, -1).join('/') : '';
        }
        
        function displayTree() {
            const container = document.getElementById('treeContainer');
            const grouped = {};
            
            allFiles.forEach(f => {
                const folder = f.folder || 'root';
                if (!grouped[folder]) grouped[folder] = [];
                grouped[folder].push(f);
            });
            
            let html = '';
            for (const [folder, files] of Object.entries(grouped)) {
                if (folder !== 'root') {
                    html += `<div class="folder-item">ğŸ“ ${folder}</div>`;
                }
                files.forEach(f => {
                    const icon = getFileIcon(f);
                    html += `
                        <div class="tree-item ${f.modified ? 'modified' : ''}" data-path="${f.path}">
                            <span class="file-icon">${icon}</span>
                            <span class="file-name">${f.name}</span>
                            ${f.modified ? '<span class="file-badge">ìˆ˜ì •</span>' : ''}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            document.getElementById('fileCount').textContent = `${allFiles.length}ê°œ íŒŒì¼`;
            
            // í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
            document.querySelectorAll('.tree-item').forEach(item => {
                item.addEventListener('click', function() {
                    const path = this.getAttribute('data-path');
                    selectFile(path);
                });
            });
        }
        
        function getFileIcon(file) {
            if (file.isImage) return 'ğŸ–¼ï¸';
            if (file.name.endsWith('.opf')) return 'ğŸ“‹';
            if (file.name.endsWith('.ncx')) return 'ğŸ“‘';
            if (file.name.endsWith('.css')) return 'ğŸ¨';
            if (file.name.endsWith('.xml')) return 'ğŸ“„';
            if (file.name.match(/\.(html|xhtml|htm)$/i)) return 'ğŸ“';
            return 'ğŸ“„';
        }
        
        function selectFile(path) {
            currentFile = allFiles.find(f => f.path === path);
            if (!currentFile) return;
            
            document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.tree-item[data-path="${path}"]`)?.classList.add('selected');
            
            displayFileComparison();
        }
        
        function displayFileComparison() {
            document.getElementById('contentHeader').classList.add('show');
            document.getElementById('currentFileName').textContent = currentFile.name;
            
            const date1Str = currentFile.date1 ? new Date(currentFile.date1).toLocaleString('ko-KR') : 'ì—†ìŒ';
            const date2Str = currentFile.date2 ? new Date(currentFile.date2).toLocaleString('ko-KR') : 'ì—†ìŒ';
            
            document.getElementById('fileMeta').innerHTML = `
                <div class="meta-item">ğŸ“– ${date1Str}</div>
                <div class="meta-item">ğŸ“• ${date2Str}</div>
            `;
            
            const view = document.getElementById('viewArea');
            
            if (currentFile.onlyInFile) {
                const content = currentFile.onlyInFile === 1 ? 
                    files1[currentFile.path]?.text : files2[currentFile.path]?.text;
                const displayContent = currentFile.isImage ? 
                    '[ì´ë¯¸ì§€ íŒŒì¼]' : visualizeWhitespace(content || '');
                
                view.innerHTML = `
                    <div class="comparison-grid">
                        <div class="pane">
                            <div class="pane-header"><div class="pane-title">${name1}</div></div>
                            <div class="diff-text">${currentFile.onlyInFile === 1 ? displayContent : 'âŒ íŒŒì¼ ì—†ìŒ'}</div>
                        </div>
                        <div class="pane">
                            <div class="pane-header"><div class="pane-title">${name2}</div></div>
                            <div class="diff-text">${currentFile.onlyInFile === 2 ? displayContent : 'âŒ íŒŒì¼ ì—†ìŒ'}</div>
                        </div>
                    </div>
                `;
                document.getElementById('diffNav').style.display = 'none';
                return;
            }
            
            if (currentFile.isImage) {
                const mimeType = getImageMimeType(currentFile.name);
                const img1 = files1[currentFile.path]?.text ? 
                    `<img src="data:${mimeType};base64,${files1[currentFile.path].text}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />` : 
                    'âŒ íŒŒì¼ ì—†ìŒ';
                const img2 = files2[currentFile.path]?.text ? 
                    `<img src="data:${mimeType};base64,${files2[currentFile.path].text}" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />` : 
                    'âŒ íŒŒì¼ ì—†ìŒ';
                
                view.innerHTML = `
                    <div class="comparison-grid">
                        <div class="pane">
                            <div class="pane-header"><div class="pane-title">${name1}</div></div>
                            <div class="diff-text">${img1}</div>
                        </div>
                        <div class="pane">
                            <div class="pane-header"><div class="pane-title">${name2}</div></div>
                            <div class="diff-text">${img2}</div>
                        </div>
                    </div>
                `;
                document.getElementById('diffNav').style.display = 'none';
                return;
            }
            
            if (!currentFile.modified) {
                view.innerHTML = `
                    <div class="comparison-grid">
                        <div class="pane">
                            <div class="pane-header"><div class="pane-title">${name1}</div></div>
                            <div class="diff-text">${visualizeWhitespace(files1[currentFile.path]?.text || 'íŒŒì¼ ì—†ìŒ')}</div>
                        </div>
                        <div class="pane">
                            <div class="pane-header"><div class="pane-title">${name2}</div></div>
                            <div class="diff-text">${visualizeWhitespace(files2[currentFile.path]?.text || 'íŒŒì¼ ì—†ìŒ')}</div>
                        </div>
                    </div>
                `;
                document.getElementById('diffNav').style.display = 'none';
                return;
            }
            
            // ë¼ì¸ ë‹¨ìœ„ ë¹„êµë¡œ ê°œì„ 
            const text1 = files1[currentFile.path]?.text || '';
            const text2 = files2[currentFile.path]?.text || '';
            
            const lines1 = text1.split('\n');
            const lines2 = text2.split('\n');
            
            let leftHtml = '', rightHtml = '';
            diffMarkers = [];
            let markerIndex = 0;
            
            // ë¼ì¸ë³„ ë§¤ì¹­ (ê°„ë‹¨í•œ ìµœì¥ ê³µí†µ ë¶€ë¶„ìˆ˜ì—´)
            const dmp = new diff_match_patch();
            const lineDiffs = dmp.diff_main(text1, text2);
            dmp.diff_cleanupSemantic(lineDiffs);
            
            // ë¼ì¸ë³„ë¡œ ì²˜ë¦¬
            let i1 = 0, i2 = 0;
            
            for (let diff of lineDiffs) {
                const [op, text] = diff;
                const diffLines = text.split('\n');
                
                if (op === 0) {
                    // ë™ì¼í•œ ë¶€ë¶„
                    for (let j = 0; j < diffLines.length; j++) {
                        if (j > 0) {
                            leftHtml += visualizeWhitespace('\n');
                            rightHtml += visualizeWhitespace('\n');
                        }
                        leftHtml += visualizeWhitespace(diffLines[j]);
                        rightHtml += visualizeWhitespace(diffLines[j]);
                    }
                } else if (op === -1) {
                    // ì‚­ì œëœ ë¶€ë¶„ (ì™¼ìª½ì—ë§Œ)
                    for (let j = 0; j < diffLines.length; j++) {
                        if (j > 0) leftHtml += visualizeWhitespace('\n');
                        if (diffLines[j].trim().length > 0 || j === diffLines.length - 1) {
                            leftHtml += `<span class="removed diff-marker" id="diff-${markerIndex}">${visualizeWhitespace(diffLines[j])}</span>`;
                            diffMarkers.push(markerIndex);
                            markerIndex++;
                        } else {
                            leftHtml += visualizeWhitespace(diffLines[j]);
                        }
                    }
                } else if (op === 1) {
                    // ì¶”ê°€ëœ ë¶€ë¶„ (ì˜¤ë¥¸ìª½ì—ë§Œ)
                    for (let j = 0; j < diffLines.length; j++) {
                        if (j > 0) rightHtml += visualizeWhitespace('\n');
                        if (diffLines[j].trim().length > 0 || j === diffLines.length - 1) {
                            rightHtml += `<span class="added diff-marker" id="diff-${markerIndex}">${visualizeWhitespace(diffLines[j])}</span>`;
                            diffMarkers.push(markerIndex);
                            markerIndex++;
                        } else {
                            rightHtml += visualizeWhitespace(diffLines[j]);
                        }
                    }
                }
            }
            
            view.innerHTML = `
                <div class="comparison-grid">
                    <div class="pane">
                        <div class="pane-header"><div class="pane-title">${name1} (ì‚­ì œ)</div></div>
                        <div class="diff-text">${leftHtml}</div>
                    </div>
                    <div class="pane">
                        <div class="pane-header"><div class="pane-title">${name2} (ì¶”ê°€)</div></div>
                        <div class="diff-text">${rightHtml}</div>
                    </div>
                </div>
            `;
            
            currentDiffIndex = 0;
            updateDiffNav();
            document.getElementById('diffNav').style.display = 'flex';
        }
        
        function updateDiffNav() {
            document.getElementById('diffCount').textContent = 
                diffMarkers.length > 0 ? `${currentDiffIndex + 1}/${diffMarkers.length}` : '0/0';
        }
        
        function nextDiff() {
            if (currentDiffIndex < diffMarkers.length - 1) {
                currentDiffIndex++;
                scrollToDiff();
            }
        }
        
        function prevDiff() {
            if (currentDiffIndex > 0) {
                currentDiffIndex--;
                scrollToDiff();
            }
        }
        
        function scrollToDiff() {
            const marker = document.getElementById(`diff-${diffMarkers[currentDiffIndex]}`);
            if (marker) {
                marker.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            updateDiffNav();
        }
        
        function updateStats(total, modified, added, deleted) {
            document.getElementById('totalFiles').textContent = total;
            document.getElementById('modifiedFiles').textContent = modified;
            document.getElementById('totalAdded').textContent = formatNum(added);
            document.getElementById('totalDeleted').textContent = formatNum(deleted);
        }
        
        function formatNum(n) {
            return n >= 1000 ? (n / 1000).toFixed(1) + 'k' : n.toString();
        }
        
        function getImageMimeType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const mimeTypes = {
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'webp': 'image/webp',
                'svg': 'image/svg+xml',
                'bmp': 'image/bmp'
            };
            return mimeTypes[ext] || 'image/png';
        }
        
        let whitespaceMode = 'special'; // 'all', 'special', 'none'
        
        function toggleWhitespaceMode() {
            const btn = document.getElementById('wsToggleBtn');
            const body = document.body;
            
            if (whitespaceMode === 'special') {
                whitespaceMode = 'all';
                body.classList.remove('hide-whitespace');
                body.classList.remove('hide-all-whitespace');
                btn.textContent = 'ëª¨ë‘ í‘œì‹œ';
            } else if (whitespaceMode === 'all') {
                whitespaceMode = 'none';
                body.classList.add('hide-all-whitespace');
                btn.textContent = 'ìˆ¨ê¸°ê¸°';
            } else {
                whitespaceMode = 'special';
                body.classList.remove('hide-all-whitespace');
                body.classList.add('hide-whitespace');
                btn.textContent = 'íŠ¹ìˆ˜ë¬¸ìë§Œ í‘œì‹œ';
            }
        }
        
        // ì´ˆê¸° ì„¤ì •: íŠ¹ìˆ˜ë¬¸ìë§Œ í‘œì‹œ
        window.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('hide-whitespace');
            
            // ë²”ë¡€ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                const legend = document.getElementById('wsLegend');
                const legendBtn = e.target.closest('.nav-btn');
                
                if (legend.classList.contains('show') && 
                    !legend.contains(e.target) && 
                    (!legendBtn || legendBtn.textContent !== 'ë²”ë¡€')) {
                    legend.classList.remove('show');
                }
            });
            
            // ESC í‚¤ë¡œ ë²”ë¡€ ë‹«ê¸°
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const legend = document.getElementById('wsLegend');
                    if (legend.classList.contains('show')) {
                        legend.classList.remove('show');
                    }
                }
            });
        });
        
        function toggleLegend() {
            const legend = document.getElementById('wsLegend');
            legend.classList.toggle('show');
        }
        
        function toggleLegend() {
            const legend = document.getElementById('wsLegend');
            legend.classList.toggle('show');
        }
        
        function visualizeWhitespace(text) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const code = char.charCodeAt(0);
                
                // HTML íŠ¹ìˆ˜ë¬¸ì escape
                if (char === '<') {
                    result += '&lt;';
                } else if (char === '>') {
                    result += '&gt;';
                } else if (char === '&') {
                    result += '&amp;';
                } else if (char === '"') {
                    result += '&quot;';
                } else if (char === "'") {
                    result += '&#39;';
                }
                // ì¼ë°˜ ê³µë°± ë¬¸ì (ì—°í•˜ê²Œ)
                else if (code === 0x0020) {
                    result += `<span class="ws ws-normal ws-space" data-code="U+0020 SPACE" title="U+0020 ì¼ë°˜ ìŠ¤í˜ì´ìŠ¤">Â·</span>`;
                } else if (code === 0x00A0) {
                    result += `<span class="ws ws-normal ws-nbsp" data-code="U+00A0 NBSP" title="U+00A0 Non-breaking space">â£</span>`;
                } else if (code === 0x0009) {
                    result += `<span class="ws ws-normal ws-tab" data-code="U+0009 TAB" title="U+0009 íƒ­">â†’</span>`;
                }
                // ì¤„ë°”ê¿ˆ ë¬¸ì (ì—°í•˜ê²Œ)
                else if (code === 0x000A) {
                    if (i > 0 && text.charCodeAt(i - 1) === 0x000D) {
                        // CRLFì˜ LF ë¶€ë¶„
                    } else {
                        result += `<span class="ws ws-normal ws-newline" data-code="U+000A LF" title="U+000A ê°œí–‰ (LF)">â†µ</span>\n`;
                    }
                } else if (code === 0x000D) {
                    if (i + 1 < text.length && text.charCodeAt(i + 1) === 0x000A) {
                        result += `<span class="ws ws-normal ws-crlf" data-code="U+000D+000A CRLF" title="U+000D+000A CRLF">â</span>\n`;
                        i++;
                    } else {
                        result += `<span class="ws ws-normal ws-cr" data-code="U+000D CR" title="U+000D ìºë¦¬ì§€ ë¦¬í„´">â</span>`;
                    }
                }
                // ë³´ì´ì§€ ì•ŠëŠ” íŠ¹ìˆ˜ ë¬¸ìë“¤ (ê°•ì¡°!)
                else if (code === 0x200B) {
                    result += `<span class="ws ws-special ws-zwsp" data-code="U+200B ZWSP" title="U+200B Zero-width space">âˆ…</span>`;
                } else if (code === 0x200C) {
                    result += `<span class="ws ws-special ws-zwnj" data-code="U+200C ZWNJ" title="U+200C Zero-width non-joiner">âŠ˜</span>`;
                } else if (code === 0x200D) {
                    result += `<span class="ws ws-special ws-zwj" data-code="U+200D ZWJ" title="U+200D Zero-width joiner">âŠ—</span>`;
                } else if (code === 0x2060) {
                    result += `<span class="ws ws-special ws-wj" data-code="U+2060 WJ" title="U+2060 Word joiner">âŠ™</span>`;
                } else if (code === 0xFEFF) {
                    result += `<span class="ws ws-special ws-zwsp" data-code="U+FEFF BOM" title="U+FEFF Zero-width no-break space (BOM)">â—</span>`;
                } else if (code === 0x00AD) {
                    result += `<span class="ws ws-special ws-shy" data-code="U+00AD SHY" title="U+00AD Soft hyphen">Â¬</span>`;
                } else if (code === 0x034F) {
                    result += `<span class="ws ws-special ws-cgj" data-code="U+034F CGJ" title="U+034F Combining grapheme joiner">âŠ•</span>`;
                } else if (code === 0x180E) {
                    result += `<span class="ws ws-special ws-zwsp" data-code="U+180E MVS" title="U+180E Mongolian vowel separator">âŠš</span>`;
                } else if (code === 0x061C) {
                    result += `<span class="ws ws-special ws-zwsp" data-code="U+061C ALM" title="U+061C Arabic letter mark">âŠ›</span>`;
                }
                // ì „ê° ìŠ¤í˜ì´ìŠ¤ë¥˜ (íŠ¹ìˆ˜)
                else if (code === 0x3000) {
                    result += `<span class="ws ws-special ws-em" data-code="U+3000 EM-SPACE" title="U+3000 ì „ê° ìŠ¤í˜ì´ìŠ¤">â–¡</span>`;
                } else if (code === 0x2003) {
                    result += `<span class="ws ws-special ws-em" data-code="U+2003 EM-SPACE" title="U+2003 Em space">â—‡</span>`;
                } else if (code === 0x2002) {
                    result += `<span class="ws ws-special ws-em" data-code="U+2002 EN-SPACE" title="U+2002 En space">â—†</span>`;
                } else if (code === 0x2004) {
                    result += `<span class="ws ws-special ws-em" data-code="U+2004 3/EM" title="U+2004 Three-per-em space">â—ˆ</span>`;
                } else if (code === 0x2005) {
                    result += `<span class="ws ws-special ws-em" data-code="U+2005 4/EM" title="U+2005 Four-per-em space">â—‰</span>`;
                } else if (code === 0x2006) {
                    result += `<span class="ws ws-special ws-em" data-code="U+2006 6/EM" title="U+2006 Six-per-em space">â—Š</span>`;
                } else if (code === 0x2009) {
                    result += `<span class="ws ws-special ws-em" data-code="U+2009 THIN" title="U+2009 Thin space">â–«</span>`;
                } else if (code === 0x200A) {
                    result += `<span class="ws ws-special ws-em" data-code="U+200A HAIR" title="U+200A Hair space">â–ª</span>`;
                } else {
                    result += char;
                }
            }
            return result;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
